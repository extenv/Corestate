const MYAPP_PREFIX="$OS$CS$${$public.ApplicationContext.getCurrentContext().applicationName}$";let lastClickedTitle="Corestate";const toggleBtn=document.getElementById("toggleBtn"),sidebar=document.getElementById("sidebar"),headerTitle=document.querySelector(".MainHeader h3"),defaultBtn=document.getElementById("defaultBtn"),jsonInput=document.getElementById("json-input"),lineNumbers=document.getElementById("line-numbers"),errorMessage=document.getElementById("error-message"),lineCount=document.getElementById("line-count"),charCount=document.getElementById("char-count");function sidebarToggle(){"closed"===(sessionStorage.getItem(MYAPP_PREFIX+"SIDEBAR_STATE")||"closed")?sidebar.classList.add("closed"):sidebar.classList.remove("closed"),toggleBtn.addEventListener("click",(()=>{sidebar.classList.toggle("closed"),sessionStorage.setItem(MYAPP_PREFIX+"SIDEBAR_STATE",sidebar.classList.contains("closed")?"closed":"open")}))}function switchTab(){const e=document.querySelectorAll(".tab-btn"),t=["table","code"],n=document.querySelector(".json-info");e.forEach((a=>{a.addEventListener("click",(()=>{e.forEach((e=>e.classList.remove("active"))),a.classList.add("active"),t.forEach((e=>{document.getElementById(e).style.display=e===a.dataset.tab?"table"===e?"inherit":"block":"none"})),n.style.display="code"===a.dataset.tab?"block":"none"}))})),n.style.display="none"}function renderTableFromJSON(){const e=document.getElementById("thead-row"),t=document.getElementById("tbody"),n=document.getElementById("table-wrapper"),a="no-json-msg";e.innerHTML="",t.innerHTML="";const l=document.getElementById(a);if(l&&l.remove(),""===jsonInput.value.trim()){const e=document.createElement("div");return e.id=a,e.textContent="No state JSON data available.",e.style.textAlign="center",e.style.padding="10px",e.style.color="gray",void n.appendChild(e)}let o;try{if(o=JSON.parse(jsonInput.value||"[]"),!Array.isArray(o)){const e=Object.values(o);o=1===e.length&&Array.isArray(e[0])?e[0]:[o]}if(1===o.length&&"object"==typeof o[0]){const e=Object.keys(o[0]);1===e.length&&Array.isArray(o[0][e[0]])&&(o=o[0][e[0]])}}catch{return}Array.isArray(o)||(o=[o]);const s=new Set;o.forEach((e=>collectKeys(e,"",1,s)));const i=Array.from(s);i.forEach((t=>{const n=document.createElement("th");n.textContent=t,e.appendChild(n)})),o.forEach(((e,n)=>{const a=document.createElement("tr");i.forEach((t=>{const l=document.createElement("td");l.textContent=getValueByPath(e,t)??"",l.addEventListener("dblclick",(()=>{const e=l.textContent,a=document.createElement("input");a.type="text",a.value=e,a.style.width="100%",l.textContent="",l.appendChild(a),a.focus(),a.addEventListener("blur",(function(){const e=a.value;l.textContent=e,setValueByPath(o[n],t,e),jsonInput.value=JSON.stringify(o,null,2),updateLineNumbers(),updateCharAndLineCount(),validateJSON(),localStorage.setItem(MYAPP_PREFIX+lastClickedTitle,jsonInput.value),sendSignal()})),a.addEventListener("keydown",(t=>{"Enter"===t.key?a.blur():"Escape"===t.key&&(l.textContent=e)}))})),a.appendChild(l)})),t.appendChild(a)}))}function collectKeys(e,t,n,a){"object"!=typeof e||null===e||n>4?t&&a.add(t):Object.keys(e).forEach((l=>{const o=t?t+"."+l:l;"object"==typeof e[l]&&null!==e[l]&&n<4?collectKeys(e[l],o,n+1,a):a.add(o)}))}function getValueByPath(e,t){return t.split(".").reduce(((e,t)=>e&&t in e?e[t]:void 0),e)}function setValueByPath(e,t,n){const a=t.split(".");let l=e;for(let e=0;e<a.length-1;e++)a[e]in l||(l[a[e]]={}),l=l[a[e]];l[a[a.length-1]]=n}function sideBar(){const e=document.getElementById("addBtn"),t=document.getElementById("searchBtn"),n=document.getElementById("searchInput"),a=document.getElementById("itemList");let l="search";function o(e=""){a.innerHTML="";const t=function(){const e=[];for(let t=0;t<localStorage.length;t++){const n=localStorage.key(t);n.startsWith(MYAPP_PREFIX)&&n!==MYAPP_PREFIX+"DEFAULT"&&e.push({key:n})}return e}();t.forEach((({key:t})=>{const n=t.replace(MYAPP_PREFIX,"");if(n.toLowerCase().includes(e)){const l=document.createElement("div");l.className="item",l.innerHTML="<span>"+n+"</span> <button>-</button>",l.addEventListener("click",(e=>{"BUTTON"!==e.target.tagName&&(headerTitle.textContent=n,lastClickedTitle=n,s(),updateJSONEditorState(n))})),l.querySelector("button").addEventListener("click",(a=>{const l=localStorage.getItem(MYAPP_PREFIX+"DEFAULT");n===l&&localStorage.removeItem(MYAPP_PREFIX+"DEFAULT"),function(e){localStorage.removeItem(e)}(t),headerTitle.textContent===n&&(lastClickedTitle="Corestate",headerTitle.textContent="Corestate",updateJSONEditorState("Corestate")),o(e),s(),a.stopPropagation()})),a.appendChild(l)}})),"Corestate"===lastClickedTitle||0===t.length?defaultBtn.style.display="none":defaultBtn.style.display="inline-block"}function s(){const e=localStorage.getItem(MYAPP_PREFIX+"DEFAULT");"Corestate"===lastClickedTitle?defaultBtn.style.display="none":(defaultBtn.style.display="inline-block",defaultBtn.disabled=e===lastClickedTitle)}n.style.display="block",e.addEventListener("click",(()=>{if("add"!==l)o(),l="add",n.placeholder="Tambah item...",n.value="",t.style.display="none",n.focus(),e.textContent="âœ“";else{const a=n.value.trim();t.style.display="block",""!==a&&(!function(e){const t=MYAPP_PREFIX+e;localStorage.setItem(t,"")}(a),o()),n.value="",n.placeholder="Cari item...",e.textContent="+",l="search"}})),t.addEventListener("click",(()=>{"search"!==l&&(l="search",n.placeholder="Cari item...",n.value="",n.style.display="block",n.focus(),e.textContent="+")})),n.addEventListener("input",(()=>{"search"===l&&o(n.value.toLowerCase())})),defaultBtn.addEventListener("click",(()=>{"Corestate"!==lastClickedTitle&&(localStorage.setItem(MYAPP_PREFIX+"DEFAULT",lastClickedTitle),s())})),function(){o();let e=localStorage.getItem(MYAPP_PREFIX+"DEFAULT")||"Corestate";headerTitle.textContent=e,lastClickedTitle=e,s(),updateJSONEditorState(e)}()}function initJSONEditor(){updateJSONEditorState(headerTitle.textContent),jsonInput.addEventListener("input",(function(){updateLineNumbers(),updateCharAndLineCount(),validateJSON(),jsonInput.disabled||"Corestate"===lastClickedTitle||(localStorage.setItem(MYAPP_PREFIX+lastClickedTitle,jsonInput.value),sendSignal()),renderTableFromJSON()})),jsonInput.addEventListener("blur",formatJSON),jsonInput.addEventListener("scroll",(function(){lineNumbers.scrollTop=jsonInput.scrollTop})),jsonInput.addEventListener("keydown",(function(e){if("Tab"===e.key){e.preventDefault();const t=this.selectionStart,n=this.selectionEnd;this.value=this.value.substring(0,t)+"  "+this.value.substring(n),this.selectionStart=this.selectionEnd=t+2,updateLineNumbers(),updateCharAndLineCount(),validateJSON(),renderTableFromJSON()}}))}function updateJSONEditorState(e){if("Corestate"===e)jsonInput.disabled=!0,jsonInput.value="",jsonInput.placeholder="Pilih item untuk mengedit state JSON.",jsonInput.style.cursor="not-allowed";else{jsonInput.disabled=!1,jsonInput.style.cursor="text",jsonInput.placeholder="Tulis atau edit state JSON di sini...";const t=localStorage.getItem(MYAPP_PREFIX+e);if(t)try{const e=JSON.parse(t);jsonInput.value=JSON.stringify(e,null,2)}catch{jsonInput.value=t}else jsonInput.value=""}updateLineNumbers(),updateCharAndLineCount(),validateJSON(),renderTableFromJSON()}function updateLineNumbers(){const e=jsonInput.value.split("\n");lineNumbers.innerHTML=e.map(((e,t)=>'<div class="line-number">'+(t+1)+"</div>")).join(""),lineCount.textContent="Row : "+e.length}function updateCharAndLineCount(){charCount.textContent="Character: "+jsonInput.value.length}function validateJSON(){try{return""===jsonInput.value.trim()?(errorMessage.style.display="none",!0):(JSON.parse(jsonInput.value),errorMessage.style.display="none",!0)}catch(e){return errorMessage.textContent="Error: "+e.message,errorMessage.style.display="block",highlightErrorLine(e),!1}}function highlightErrorLine(e){const t=e.message.match(/position\s+(\d+)/);if(!t)return;const n=parseInt(t[1]),a=jsonInput.value.substring(0,n).split("\n").length,l=parseInt(getComputedStyle(jsonInput).lineHeight);jsonInput.scrollTop=(a-3)*l}function formatJSON(){try{if(""===jsonInput.value.trim())return;const e=JSON.parse(jsonInput.value);jsonInput.value=JSON.stringify(e,null,2),updateLineNumbers(),updateCharAndLineCount(),validateJSON()}catch{validateJSON()}}function sendSignal(){new BroadcastChannel("State_channel").postMessage("trigger_state")}sidebarToggle(),switchTab(),sideBar(),initJSONEditor(),renderTableFromJSON();
